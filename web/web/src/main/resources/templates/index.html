<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>VitalSync</title>

        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Iconos Phosphor (Librer√≠a Profesional Minimalista) -->
        <script src="https://unpkg.com/@phosphor-icons/web"></script>

        <link rel="manifest" href="/manifest.json">
        <meta name="theme-color" content="#00695c">

        <style>
            /* --- TU PALETA DE COLORES ORIGINAL --- */
            :root {
                --medical-primary: #00695c;
                --medical-light: #e0f2f1;
                --medical-accent: #00897b;
                --bg-soft: #f4f9f8;
                --text-dark: #263238;
                --text-muted: #546e7a;
                --success-dark: #2e7d32;
                --danger-dark: #c62828;
            }

            body {
                background-color: var(--bg-soft);
                padding-bottom: 100px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                color: var(--text-dark);
            }

            /* HEADER */
            .header-app {
                background-color: var(--medical-primary);
                color: white;
                padding: 15px 20px;
                border-bottom-left-radius: 20px;
                border-bottom-right-radius: 20px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .logo-img {
                height: 50px;
                width: auto;
                background: white;
                padding: 5px;
                border-radius: 8px;
                margin-right: 15px;
            }

            /* TARJETAS */
            .card-cita {
                border: 1px solid #dae0e5;
                border-radius: 16px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                margin-bottom: 20px;
                background: white;
            }
            .card-body {
                padding: 1.2rem;
            }

            /* TIPOGRAF√çA */
            h2, h3, h4 {
                font-weight: 700;
                color: var(--medical-primary);
                letter-spacing: -0.5px;
            }

            /* FILTROS */
            .filtro-container {
                background: white;
                padding: 20px;
                border-radius: 15px;
                border: 1px solid #dceae5;
                box-shadow: 0 2px 4px rgba(0,0,0,0.03);
                margin-bottom: 25px;
                border-left: 6px solid var(--medical-primary);
            }

            .input-fecha-grande {
                border: 2px solid #b0bec5;
                border-radius: 10px;
                padding: 12px;
                font-size: 1.2rem;
                width: 100%;
                margin-bottom: 10px;
                color: var(--text-dark);
                background-color: #fafafa;
            }
            .input-fecha-grande:focus {
                border-color: var(--medical-primary);
                box-shadow: 0 0 0 0.25rem rgba(0, 105, 92, 0.25);
            }

            /* BOTONES */
            .btn-reservar {
                background-color: var(--medical-accent);
                border: none;
                color: white;
                border-radius: 12px;
                padding: 16px;
                font-weight: bold;
                width: 100%;
                font-size: 1.2rem;
                letter-spacing: 0.5px;
            }
            .btn-reservar:hover {
                background-color: var(--medical-primary);
            }

            .btn-cancelar {
                background-color: white;
                border: 2px solid var(--danger-dark);
                color: var(--danger-dark);
                border-radius: 12px;
                padding: 14px;
                font-weight: bold;
                width: 100%;
                font-size: 1.1rem;
            }

            /* MEN√ö INFERIOR */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                height: 85px;
                display: flex;
                justify-content: space-around;
                align-items: center;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
                z-index: 2000;
                border-top: 1px solid #e0e0e0;
            }
            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-decoration: none;
                color: var(--text-muted);
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
            }
            .nav-item.active {
                color: var(--medical-primary);
                border-bottom: 4px solid var(--medical-primary);
                padding-bottom: 5px;
            }
            /* Iconos m√°s grandes y alineados */
            .nav-item i {
                font-size: 1.8rem;
                margin-bottom: 4px;
            }

            /* BADGES */
            .badge-disponible {
                background-color: var(--medical-light);
                color: var(--medical-primary);
                border: 1px solid var(--medical-primary);
            }
            .badge-confirmada {
                background-color: #e8f5e9;
                color: var(--success-dark);
                border: 1px solid var(--success-dark);
            }

            /* VISTAS */
            .vista {
                display: none;
            }
            .vista-activa {
                display: block;
                animation: fadeIn 0.4s;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            .hidden-by-filter {
                display: none !important;
            }

            /* MODAL */
            .modal-content {
                border-radius: 20px;
                border: none;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }
            .modal-header {
                background-color: var(--medical-primary);
                color: white;
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
            }
            .detalle-confirmacion {
                background: #f5f5f5;
                padding: 15px;
                border-radius: 10px;
                margin: 15px 0;
            }
            .detalle-label {
                font-size: 0.9rem;
                color: #666;
                font-weight: bold;
                text-transform: uppercase;
            }
            .detalle-valor {
                font-size: 1.2rem;
                color: #333;
                font-weight: bold;
                margin-bottom: 10px;
            }
        </style>
    </head>
    <body>

        <!-- VISTA 1: INICIO -->
        <div id="vista-inicio" class="vista vista-activa">
            <div class="header-app d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <img src="/img/logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none'">
                    <div>
                        <h2 class="m-0 fw-bold text-white" style="font-size: 1.5rem;">VitalSync</h2>
                        <p class="m-0 text-white-50" style="font-size: 0.9rem;">Salud Simplificada</p>
                    </div>
                </div>
                <div class="text-end text-white">
                    <small class="d-block opacity-75">Bienvenido</small>
                    <strong th:text="${usuario.nombreCompleto}">Paciente</strong>
                </div>
            </div>

            <div class="container">
                <div th:if="${mensaje}" class="alert alert-dismissible fade show shadow-sm p-4" 
                     th:classappend="${'alert-' + tipo}" role="alert" style="border-radius: 12px; font-size: 1.1rem;">
                    <strong th:text="${mensaje}"></strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-6">
                        <div onclick="navegar('buscar')" class="card-cita p-4 d-flex align-items-center justify-content-between" 
                             style="cursor:pointer; border-left: 8px solid var(--medical-primary);">
                            <div>
                                <h3 class="mb-1" style="color: var(--medical-primary);">Buscar Hora</h3>
                                <p class="text-muted mb-0">Reservar nueva atenci√≥n</p>
                            </div>
                            <!-- Icono Phosphor: Lupa -->
                            <i class="ph ph-magnifying-glass" style="font-size: 3rem; color: var(--medical-primary);"></i>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div onclick="navegar('citas')" class="card-cita p-4 d-flex align-items-center justify-content-between" 
                             style="cursor:pointer; border-left: 8px solid var(--success-dark);">
                            <div>
                                <h3 class="mb-1" style="color: var(--success-dark);">Mis Citas</h3>
                                <p class="text-muted mb-0">Revise sus horas agendadas</p>
                            </div>
                            <!-- Icono Phosphor: Calendario -->
                            <i class="ph ph-calendar-check" style="font-size: 3rem; color: var(--success-dark);"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 2: BUSCAR -->
        <div id="vista-buscar" class="vista">
            <div class="header-app pt-3 pb-4">
                <h2 class="m-0 text-white">Reservar Hora</h2>
                <p class="m-0 text-white-50">Elija una fecha para ver doctores</p>
            </div>

            <div class="container" style="margin-top: -20px;">
                <div class="filtro-container">
                    <h5 class="fw-bold mb-3" style="color: var(--medical-primary);">üìÖ Seleccione las fechas:</h5>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="fw-bold text-muted mb-1">DESDE (Inicio):</label>
                            <input type="date" id="fechaInicio" class="input-fecha-grande" onchange="filtrarPorFechas()">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="fw-bold text-muted mb-1">HASTA (Fin):</label>
                            <input type="date" id="fechaFin" class="input-fecha-grande" onchange="filtrarPorFechas()">
                        </div>
                    </div>
                    <p id="resultado-filtro" class="mt-3 mb-0 fw-bold" style="color: var(--medical-primary); font-size: 1.1rem;">
                        Mostrando todas las horas disponibles.
                    </p>
                </div>

                <div id="lista-horas">
                    <div th:if="${#lists.isEmpty(disponibles)}" class="text-center p-5 bg-white rounded-3 shadow-sm">
                        <h4>No hay horas cargadas.</h4>
                    </div>

                    <div class="card card-cita item-cita" th:each="hora : ${disponibles}" th:attr="data-fecha=${#temporals.format(hora.fechaHora, 'yyyy-MM-dd')}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge badge-disponible px-3 py-2 rounded-pill fw-bold">DISPONIBLE</span>
                                <span class="fw-bold" style="color: var(--text-muted); font-size: 1.1rem;" th:text="${hora.especialidad}">Especialidad</span>
                            </div>
                            <h4 class="card-title mb-1 fw-bold" style="color: var(--text-dark);" th:text="${hora.nombreMedico}">Doctor</h4>
                            <div class="d-flex align-items-center gap-3 my-4 p-3 rounded-3" style="background-color: var(--bg-soft);">
                                <div class="text-center pe-3 border-end border-2">
                                    <div class="fw-bold text-uppercase" style="color: var(--text-muted);" th:text="${#temporals.format(hora.fechaHora, 'MMM').toUpperCase()}">MES</div>
                                    <div class="fs-1 fw-bold" style="line-height:1; color:var(--medical-primary);" th:text="${#temporals.format(hora.fechaHora, 'dd')}">01</div>
                                </div>
                                <div>
                                    <div class="fs-2 fw-bold" style="color: var(--text-dark);" th:text="${#temporals.format(hora.fechaHora, 'HH:mm')}">00:00</div>
                                    <div class="fw-bold text-muted" th:text="${#temporals.format(hora.fechaHora, 'EEEE')}">D√≠a</div>
                                </div>
                            </div>

                            <button class="btn-reservar shadow-sm" 
                                    th:data-id="${hora.idCita}"
                                    th:data-medico="${hora.nombreMedico}"
                                    th:data-especialidad="${hora.especialidad}"
                                    th:data-fecha="${#temporals.format(hora.fechaHora, 'dd-MM-yyyy')}"
                                    th:data-hora="${#temporals.format(hora.fechaHora, 'HH:mm')}"
                                    onclick="abrirModalConfirmacion(this)">
                                RESERVAR HORA
                            </button>
                        </div>
                    </div>
                </div>
                <br>
            </div>
        </div>

        <!-- VISTA 3: MIS CITAS -->
        <div id="vista-citas" class="vista">
            <div class="header-app pt-3 pb-4" style="background-color: var(--success-dark);">
                <h2 class="m-0 text-white">Mis Citas</h2>
                <p class="m-0 text-white-50">Sus atenciones confirmadas</p>
            </div>

            <div class="container" style="margin-top: -20px;">
                <div th:if="${#lists.isEmpty(misCitas)}" class="text-center p-5 bg-white rounded-4 shadow-sm">
                    <!-- Icono Phosphor: Bandeja vac√≠a -->
                    <i class="ph ph-tray" style="font-size: 4rem; opacity: 0.5; color: var(--text-muted);"></i>
                    <h4 class="mt-3 text-muted">No tiene citas pendientes.</h4>
                    <button onclick="navegar('buscar')" class="btn btn-outline-secondary mt-3 rounded-pill px-4 py-2 fw-bold">Ir a Reservar</button>
                </div>

                <div class="card card-cita confirmada" th:each="cita : ${misCitas}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <span class="badge badge-confirmada px-3 py-2 rounded-pill fw-bold">CONFIRMADA</span>
                                <h5 class="mb-0 fw-bold text-dark" th:text="${cita.nombreMedico}">Dr. Nombre</h5>
                                <small class="text-muted" th:text="${cita.especialidad}">Especialidad</small>
                            </div>
                            <div class="bg-success bg-opacity-10 p-2 rounded-circle text-success">
                                <!-- Icono Phosphor: Check -->
                                <i class="ph ph-check-circle" style="font-size: 1.5rem;"></i>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="date-badge border">
                                <div class="date-month text-success" th:text="${#temporals.format(cita.fechaHora, 'MMM')}">MES</div>
                                <div class="date-day text-dark" th:text="${#temporals.format(cita.fechaHora, 'dd')}">01</div>
                            </div>
                            <div>
                                <div class="fs-5 fw-bold text-dark" th:text="${#temporals.format(cita.fechaHora, 'HH:mm')}">Hora</div>
                                <small class="text-muted">Horario de atenci√≥n</small>
                            </div>
                        </div>

                        <form action="/cancelar" method="post" onsubmit="return confirm('¬øSeguro? Recuerde la regla de 24h.');">
                            <input type="hidden" name="idCita" th:value="${cita.idCita}"/>
                            <button type="submit" class="btn-cancelar">
                                CANCELAR CITA
                            </button>
                        </form>
                    </div>
                </div>
                <div style="height: 20px;"></div>
            </div>
        </div>

        <!-- VISTA 4: PERFIL -->
        <div id="vista-perfil" class="vista">
            <div class="header-app pb-5" style="background: linear-gradient(135deg, #1e293b, #0f172a);">
                <h2 class="m-0 text-white">Perfil</h2>
                <p class="m-0 text-white-50 small">Mi cuenta</p>
            </div>
            <div class="container" style="margin-top: -30px; position: relative; z-index: 20;">
                <div class="card card-cita p-4">
                    <div class="text-center mb-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-light rounded-circle" style="width:80px; height:80px;">
                            <!-- Icono Phosphor: Usuario grande -->
                            <i class="ph ph-user" style="font-size: 3rem; color: #94a3b8;"></i>
                        </div>
                        <h4 class="mt-3 mb-0" th:text="${usuario.nombreCompleto}">Nombre</h4>
                        <span class="text-muted small">Paciente</span>
                    </div>

                    <div class="list-group list-group-flush mb-4 rounded-3 overflow-hidden border">
                        <div class="list-group-item d-flex justify-content-between align-items-center p-3 gap-3">
                            <span class="text-muted small fw-bold flex-shrink-0">CORREO</span>
                            <span class="fw-medium text-end text-truncate" th:text="${usuario.email}">email@ejemplo.com</span>
                        </div>
                    </div>

                    <a href="/logout" class="btn btn-outline-danger w-100 rounded-pill py-2 fw-bold border-2">
                        Cerrar Sesi√≥n
                    </a>
                </div>
            </div>
        </div>

        <!-- MEN√ö FLOTANTE INFERIOR -->
        <nav class="bottom-nav">
            <div onclick="navegar('inicio')" class="nav-item active" id="btn-inicio">
                <i class="ph ph-house"></i> Inicio
            </div>
            <div onclick="navegar('buscar')" class="nav-item" id="btn-buscar">
                <i class="ph ph-magnifying-glass"></i> Buscar
            </div>
            <div onclick="navegar('citas')" class="nav-item" id="btn-citas">
                <i class="ph ph-calendar-check"></i> Citas
            </div>
            <div onclick="navegar('perfil')" class="nav-item" id="btn-perfil">
                <i class="ph ph-user-circle"></i> Perfil
            </div>
        </nav>

        <!-- MODAL CONFIRMACI√ìN -->
        <div class="modal fade" id="modalConfirmar" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-dark">Confirmar Cita</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="p-3 bg-light rounded-3 mb-3 text-center">
                            <div class="text-muted small fw-bold mb-1">M√âDICO</div>
                            <div class="fs-5 fw-bold text-primary mb-3" id="modalMedico">Dr. Nombre</div>

                            <div class="row g-2">
                                <div class="col-6 border-end">
                                    <div class="text-muted small fw-bold">FECHA</div>
                                    <div class="text-dark fw-bold" id="modalFecha">--</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted small fw-bold">HORA</div>
                                    <div class="text-dark fw-bold" id="modalHora">--:--</div>
                                </div>
                            </div>
                        </div>
                        <p class="text-center text-muted small mb-0">Se enviar√° una confirmaci√≥n a su correo.</p>
                    </div>
                    <div class="modal-footer flex-column border-0 pt-0">
                        <form action="/reservar" method="post" class="w-100">
                            <input type="hidden" name="idCita" id="modalIdCita"/>
                            <button type="submit" class="btn-reservar shadow-sm">CONFIRMAR RESERVA</button>
                        </form>
                        <button type="button" class="btn btn-link text-muted text-decoration-none mt-2" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
                function navegar(vista) {
                    document.querySelectorAll('.vista').forEach(el => el.classList.remove('vista-activa'));
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.getElementById('vista-' + vista).classList.add('vista-activa');
                    document.getElementById('btn-' + vista).classList.add('active');
                    window.scrollTo(0, 0);
                }

                function filtrarPorFechas() {
                    const inicio = document.getElementById('fechaInicio').value;
                    const fin = document.getElementById('fechaFin').value;
                    const cards = document.querySelectorAll('.item-cita');
                    let count = 0;
                    const feedback = document.getElementById('resultado-filtro');

                    feedback.innerText = 'Actualizando...';

                    setTimeout(() => {
                        cards.forEach(c => {
                            const fecha = c.getAttribute('data-fecha');
                            let show = true;
                            if (inicio && fecha < inicio)
                                show = false;
                            if (fin && fecha > fin)
                                show = false;
                            c.style.display = show ? 'block' : 'none';
                            if (show)
                                count++;
                        });
                        feedback.innerHTML = count > 0 ? `‚úÖ ${count} horas encontradas` : '‚ùå No hay horas en este rango';
                        feedback.className = count > 0 ? 'mt-3 small fw-bold text-center text-success bg-success-subtle p-2 rounded-3' : 'mt-3 small fw-bold text-center text-danger bg-danger-subtle p-2 rounded-3';
                    }, 100);
                }

                function abrirModalConfirmacion(btn) {
                    document.getElementById('modalIdCita').value = btn.getAttribute('data-id');
                    document.getElementById('modalMedico').innerText = btn.getAttribute('data-medico');
                    document.getElementById('modalFecha').innerText = btn.getAttribute('data-fecha');
                    document.getElementById('modalHora').innerText = btn.getAttribute('data-hora');
                    new bootstrap.Modal(document.getElementById('modalConfirmar')).show();
                }

                window.onload = function () {
                    // Fecha Demo (Diciembre 2025)
                    const inicioDemo = "2025-12-01";
                    const finDemo = "2025-12-31";

                    const inputInicio = document.getElementById('fechaInicio');
                    const inputFin = document.getElementById('fechaFin');

                    if (inputInicio && inputFin) {
                        inputInicio.value = inicioDemo;
                        inputFin.value = finDemo;
                        filtrarPorFechas();
                    }
                };
        </script>
    </body>
</html>